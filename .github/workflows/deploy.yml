name: Deploy via SFTP

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Delete remote public folder contents
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          PUBLIC_DIR_PATH: ${{ vars.PUBLIC_DIR_PATH }}
        run: |
          if [ -z "${PUBLIC_DIR_PATH}" ]; then echo "PUBLIC_DIR_PATH is not set"; exit 1; fi
          lftp -u "${SFTP_USER}","${SFTP_PASSWORD}" "sftp://${SFTP_HOST}:${SFTP_PORT:-22}" -e "set cmd:fail-exit yes; set sftp:auto-confirm yes; set net:max-retries 2; set net:persist-retries 2; cd \"${PUBLIC_DIR_PATH}\"; glob -a rm -r -- * .[!.]* ..?*; bye"

      - name: Upload build
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          PUBLIC_DIR_PATH: ${{ vars.PUBLIC_DIR_PATH }}
        run: |
          if [ -z "${PUBLIC_DIR_PATH}" ]; then echo "PUBLIC_DIR_PATH is not set"; exit 1; fi
          lftp -u "${SFTP_USER}","${SFTP_PASSWORD}" "sftp://${SFTP_HOST}:${SFTP_PORT:-22}" -e "set cmd:fail-exit yes; set sftp:auto-confirm yes; set net:max-retries 2; set net:persist-retries 2; mirror -R ./dist/ ${PUBLIC_DIR_PATH} --parallel=2; bye"
